{"ast":null,"code":"/**\r\n * Store de autenticación con Zustand\r\n * Gestiona el estado del usuario autenticado\r\n */\nimport { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport { supabase } from '../../../config/supabase';\nimport { apiClient } from '../../../shared/services/api/apiClient';\nimport { API_ENDPOINTS } from '../../../shared/services/api/endpoints';\nconst useAuthStore = create(persist((set, get) => ({\n  // Estado\n  user: null,\n  userProfile: null,\n  // Datos del backend\n  cliente: null,\n  loading: false,\n  error: null,\n  isAuthenticated: false,\n  isAdmin: false,\n  // Acciones\n  setLoading: loading => set({\n    loading\n  }),\n  setError: error => set({\n    error\n  }),\n  // Obtener perfil del usuario desde el backend\n  fetchUserProfile: async userId => {\n    try {\n      // Obtener datos del usuario del backend\n      const usuario = await apiClient.get(API_ENDPOINTS.CLIENTE_BY_USUARIO(userId));\n      set({\n        cliente: usuario\n      });\n\n      // Determinar si es admin\n      const userData = JSON.parse(localStorage.getItem('usuario') || '{}');\n      const isAdmin = userData.rol === 'admin';\n      set({\n        isAdmin,\n        userProfile: {\n          ...usuario,\n          rol: userData.rol\n        }\n      });\n    } catch (error) {\n      console.error('Error obteniendo perfil:', error);\n    }\n  },\n  // Inicializar autenticación desde Supabase\n  initializeAuth: async () => {\n    set({\n      loading: true\n    });\n    try {\n      const {\n        data: {\n          session\n        },\n        error\n      } = await supabase.auth.getSession();\n      if (error) throw error;\n      if (session !== null && session !== void 0 && session.user) {\n        set({\n          user: session.user,\n          isAuthenticated: true,\n          loading: false\n        });\n        await get().fetchUserProfile(session.user.id);\n      } else {\n        set({\n          user: null,\n          isAuthenticated: false,\n          loading: false\n        });\n      }\n    } catch (error) {\n      set({\n        error: error.message,\n        loading: false\n      });\n    }\n  },\n  // Login con backend (mantener compatibilidad)\n  login: async (email, password) => {\n    set({\n      loading: true,\n      error: null\n    });\n    try {\n      // Login en backend\n      const backendData = await apiClient.post(API_ENDPOINTS.LOGIN, {\n        correo: email,\n        contraseña: password\n      });\n\n      // Guardar token\n      localStorage.setItem('token', backendData.access_token);\n\n      // Decodificar token para obtener datos del usuario\n      const {\n        jwtDecode\n      } = await import('jwt-decode');\n      const decoded = jwtDecode(backendData.access_token);\n      const userData = {\n        id: decoded.id_usuario,\n        correo: decoded.sub,\n        rol: decoded.rol\n      };\n      localStorage.setItem('usuario', JSON.stringify(userData));\n\n      // También hacer login en Supabase si es necesario\n      const {\n        data: supabaseUser\n      } = await supabase.auth.signInWithPassword({\n        email,\n        password\n      });\n      set({\n        user: (supabaseUser === null || supabaseUser === void 0 ? void 0 : supabaseUser.user) || {\n          id: decoded.id_usuario,\n          email: decoded.sub\n        },\n        userProfile: userData,\n        isAuthenticated: true,\n        isAdmin: decoded.rol === 'admin',\n        loading: false\n      });\n      await get().fetchUserProfile(decoded.id_usuario);\n      return {\n        success: true\n      };\n    } catch (error) {\n      const errorMessage = error.message || 'Error al iniciar sesión';\n      set({\n        error: errorMessage,\n        loading: false\n      });\n      return {\n        success: false,\n        error: errorMessage\n      };\n    }\n  },\n  // Registro\n  register: async (email, password, userData) => {\n    set({\n      loading: true,\n      error: null\n    });\n    try {\n      // Crear usuario en backend\n      const usuario = await apiClient.post(API_ENDPOINTS.USUARIOS, {\n        correo: email,\n        contraseña: password,\n        rol: 'cliente'\n      });\n\n      // Crear cliente\n      await apiClient.post(API_ENDPOINTS.CLIENTES, {\n        id_usuario: usuario.id_usuario,\n        nombre: userData.nombre,\n        apellido: userData.apellido,\n        telefono: userData.telefono,\n        direccion: userData.direccion\n      });\n\n      // Guardar usuario básico\n      localStorage.setItem('usuario', JSON.stringify({\n        id: usuario.id_usuario,\n        rol: usuario.rol\n      }));\n\n      // Login automático después del registro\n      return await get().login(email, password);\n    } catch (error) {\n      const errorMessage = error.message || 'Error al registrarse';\n      set({\n        error: errorMessage,\n        loading: false\n      });\n      return {\n        success: false,\n        error: errorMessage\n      };\n    }\n  },\n  // Logout\n  logout: async () => {\n    set({\n      loading: true\n    });\n    try {\n      await supabase.auth.signOut();\n      localStorage.removeItem('token');\n      localStorage.removeItem('usuario');\n      set({\n        user: null,\n        userProfile: null,\n        cliente: null,\n        isAuthenticated: false,\n        isAdmin: false,\n        loading: false\n      });\n    } catch (error) {\n      set({\n        error: error.message,\n        loading: false\n      });\n    }\n  }\n}), {\n  name: 'auth-storage',\n  // Solo persistir datos no sensibles\n  partialize: state => ({\n    user: state.user ? {\n      id: state.user.id,\n      email: state.user.email\n    } : null\n  })\n}));\nexport default useAuthStore;","map":{"version":3,"names":["create","persist","supabase","apiClient","API_ENDPOINTS","useAuthStore","set","get","user","userProfile","cliente","loading","error","isAuthenticated","isAdmin","setLoading","setError","fetchUserProfile","userId","usuario","CLIENTE_BY_USUARIO","userData","JSON","parse","localStorage","getItem","rol","console","initializeAuth","data","session","auth","getSession","id","message","login","email","password","backendData","post","LOGIN","correo","contraseña","setItem","access_token","jwtDecode","decoded","id_usuario","sub","stringify","supabaseUser","signInWithPassword","success","errorMessage","register","USUARIOS","CLIENTES","nombre","apellido","telefono","direccion","logout","signOut","removeItem","name","partialize","state"],"sources":["C:/Users/jesus/Desktop/mantenimiento/front_rosaline/front_gestion/src/features/auth/store/authStore.js"],"sourcesContent":["/**\r\n * Store de autenticación con Zustand\r\n * Gestiona el estado del usuario autenticado\r\n */\r\nimport { create } from 'zustand';\r\nimport { persist } from 'zustand/middleware';\r\nimport { supabase } from '../../../config/supabase';\r\nimport { apiClient } from '../../../shared/services/api/apiClient';\r\nimport { API_ENDPOINTS } from '../../../shared/services/api/endpoints';\r\n\r\nconst useAuthStore = create(\r\n  persist(\r\n    (set, get) => ({\r\n      // Estado\r\n      user: null,\r\n      userProfile: null, // Datos del backend\r\n      cliente: null,\r\n      loading: false,\r\n      error: null,\r\n      isAuthenticated: false,\r\n      isAdmin: false,\r\n\r\n      // Acciones\r\n      setLoading: (loading) => set({ loading }),\r\n      setError: (error) => set({ error }),\r\n\r\n      // Obtener perfil del usuario desde el backend\r\n      fetchUserProfile: async (userId) => {\r\n        try {\r\n          // Obtener datos del usuario del backend\r\n          const usuario = await apiClient.get(API_ENDPOINTS.CLIENTE_BY_USUARIO(userId));\r\n          set({ cliente: usuario });\r\n\r\n          // Determinar si es admin\r\n          const userData = JSON.parse(localStorage.getItem('usuario') || '{}');\r\n          const isAdmin = userData.rol === 'admin';\r\n          set({ isAdmin, userProfile: { ...usuario, rol: userData.rol } });\r\n        } catch (error) {\r\n          console.error('Error obteniendo perfil:', error);\r\n        }\r\n      },\r\n\r\n      // Inicializar autenticación desde Supabase\r\n      initializeAuth: async () => {\r\n        set({ loading: true });\r\n        try {\r\n          const { data: { session }, error } = await supabase.auth.getSession();\r\n          \r\n          if (error) throw error;\r\n\r\n          if (session?.user) {\r\n            set({ \r\n              user: session.user, \r\n              isAuthenticated: true,\r\n              loading: false \r\n            });\r\n            await get().fetchUserProfile(session.user.id);\r\n          } else {\r\n            set({ \r\n              user: null, \r\n              isAuthenticated: false,\r\n              loading: false \r\n            });\r\n          }\r\n        } catch (error) {\r\n          set({ error: error.message, loading: false });\r\n        }\r\n      },\r\n\r\n      // Login con backend (mantener compatibilidad)\r\n      login: async (email, password) => {\r\n        set({ loading: true, error: null });\r\n        try {\r\n          // Login en backend\r\n          const backendData = await apiClient.post(API_ENDPOINTS.LOGIN, {\r\n            correo: email,\r\n            contraseña: password,\r\n          });\r\n\r\n          // Guardar token\r\n          localStorage.setItem('token', backendData.access_token);\r\n\r\n          // Decodificar token para obtener datos del usuario\r\n          const { jwtDecode } = await import('jwt-decode');\r\n          const decoded = jwtDecode(backendData.access_token);\r\n          \r\n          const userData = {\r\n            id: decoded.id_usuario,\r\n            correo: decoded.sub,\r\n            rol: decoded.rol,\r\n          };\r\n\r\n          localStorage.setItem('usuario', JSON.stringify(userData));\r\n\r\n          // También hacer login en Supabase si es necesario\r\n          const { data: supabaseUser } = await supabase.auth.signInWithPassword({\r\n            email,\r\n            password,\r\n          });\r\n\r\n          set({ \r\n            user: supabaseUser?.user || { id: decoded.id_usuario, email: decoded.sub },\r\n            userProfile: userData,\r\n            isAuthenticated: true,\r\n            isAdmin: decoded.rol === 'admin',\r\n            loading: false \r\n          });\r\n\r\n          await get().fetchUserProfile(decoded.id_usuario);\r\n\r\n          return { success: true };\r\n        } catch (error) {\r\n          const errorMessage = error.message || 'Error al iniciar sesión';\r\n          set({ error: errorMessage, loading: false });\r\n          return { success: false, error: errorMessage };\r\n        }\r\n      },\r\n\r\n      // Registro\r\n      register: async (email, password, userData) => {\r\n        set({ loading: true, error: null });\r\n        try {\r\n          // Crear usuario en backend\r\n          const usuario = await apiClient.post(API_ENDPOINTS.USUARIOS, {\r\n            correo: email,\r\n            contraseña: password,\r\n            rol: 'cliente',\r\n          });\r\n\r\n          // Crear cliente\r\n          await apiClient.post(API_ENDPOINTS.CLIENTES, {\r\n            id_usuario: usuario.id_usuario,\r\n            nombre: userData.nombre,\r\n            apellido: userData.apellido,\r\n            telefono: userData.telefono,\r\n            direccion: userData.direccion,\r\n          });\r\n\r\n          // Guardar usuario básico\r\n          localStorage.setItem('usuario', JSON.stringify({\r\n            id: usuario.id_usuario,\r\n            rol: usuario.rol,\r\n          }));\r\n\r\n          // Login automático después del registro\r\n          return await get().login(email, password);\r\n        } catch (error) {\r\n          const errorMessage = error.message || 'Error al registrarse';\r\n          set({ error: errorMessage, loading: false });\r\n          return { success: false, error: errorMessage };\r\n        }\r\n      },\r\n\r\n      // Logout\r\n      logout: async () => {\r\n        set({ loading: true });\r\n        try {\r\n          await supabase.auth.signOut();\r\n          localStorage.removeItem('token');\r\n          localStorage.removeItem('usuario');\r\n          \r\n          set({ \r\n            user: null,\r\n            userProfile: null,\r\n            cliente: null,\r\n            isAuthenticated: false,\r\n            isAdmin: false,\r\n            loading: false \r\n          });\r\n        } catch (error) {\r\n          set({ error: error.message, loading: false });\r\n        }\r\n      },\r\n    }),\r\n    {\r\n      name: 'auth-storage',\r\n      // Solo persistir datos no sensibles\r\n      partialize: (state) => ({ \r\n        user: state.user ? { id: state.user.id, email: state.user.email } : null \r\n      }),\r\n    }\r\n  )\r\n);\r\n\r\nexport default useAuthStore;\r\n\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}